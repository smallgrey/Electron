(()=>{"use strict";const e=function(){function e(){}return e.getCurrentTime=function(){var e=new Date,n=e.getMonth()+1,t=e.getDate()+1,o=e.getHours(),r=e.getMinutes(),i=e.getSeconds();return n<=9&&(n="0"+n),t<=9&&(t="0"+t),o<=9&&(o="0"+o),r<=9&&(r="0"+r),i<=9&&(i="0"+i),"["+e.getFullYear()+"-"+n+"-"+t+" "+o+":"+r+":"+i+"]"},e.error=function(n){for(var t=[],o=1;o<arguments.length;o++)t[o-1]=arguments[o];console.error(e.getCurrentTime()+"["+n+"][error]: "+t)},e.debug=function(n){for(var t=[],o=1;o<arguments.length;o++)t[o-1]=arguments[o];console.debug(e.getCurrentTime()+"["+n+"][debug]: "+t)},e.info=function(n){for(var t=[],o=1;o<arguments.length;o++)t[o-1]=arguments[o];console.info(e.getCurrentTime()+"["+n+"][info]: "+t)},e._instance=new e,e}(),n=function(){function n(){}return n.subscribe=function(t,o){n.topics[t]||(n.topics[t]=[]);var r=++n.Uid;e.info("Observer","subscribe topic:"+t+", uid="+r),n.topics[t].push({token:r,func:o})},n.publish=function(e,t){if(!n.topics[e])return!1;for(var o=0;o<n.topics[e].length;o++)n.topics[e][o].func(t)},n.reconnect=function(){n.isReconnect=1},n.resetReconnect=function(){n.isReconnect=0},n.getReconnectStatus=function(){return n.isReconnect},n.topics={},n.Uid=-1,n.isReconnect=0,n}(),t=function(){function e(e){this.serviceTunnel=e.socket}return e.prototype.sendData=function(e){var n=JSON.stringify(e);this.serviceTunnel.socket&&this.serviceTunnel.sendData(n)},e.prototype.callbackResponse=function(e,n){e.response&&"function"==typeof e.response&&(this.serviceTunnel.rspFuncs[n]=e.response)},e.prototype.login=function(e,n){this.callbackResponse(n,1001);var t={cmd:1001,description:"tsdk_login",param:{loginParam:e}};this.sendData(t)},e.prototype.setBasicEvent=function(e){"function"==typeof e.onEvtLoginSuccess&&(this.serviceTunnel.notifyFuncs[1002]=e.onEvtLoginSuccess),"function"==typeof e.onEvtLoginFailed&&(this.serviceTunnel.notifyFuncs[1003]=e.onEvtLoginFailed)},e}(),o=function(){function e(e){var n,t=this;this.notifyFuncs=[],this.rspFuncs=[];var o=e.svraddr||"127.0.0.1",r=e.svrport||"3000";e.ssl,this.socket=null,this.socket=wx.connectSocket({url:"wss://"+o+":"+r+"/"}),wx.onSocketOpen(e.ready),wx.onSocketClose(e.close),wx.onSocketError(e.error),wx.onSocketMessage((function(e){var n=JSON.parse(e.data);if(n.notify&&n.notify>0){var o=n.notify;"function"==typeof t.notifyFuncs[o]&&t.notifyFuncs[o](n)}if(n.rsp&&n.rsp>0){var r=n.rsp;"function"==typeof t.rspFuncs[r]&&t.rspFuncs[r](n)}}))}return e.prototype.sendData=function(e){wx.sendSocketMessage({data:e})},e}(),r=function(){function e(e){this.serviceTunnel=e.socket}return e.prototype.sendData=function(e){var n=JSON.stringify(e);this.serviceTunnel.socket&&this.serviceTunnel.sendData(n)},e.prototype.callbackResponse=function(e,n){e.response&&"function"==typeof e.response&&(this.serviceTunnel.rspFuncs[n]=e.response)},e.prototype.searchLadp=function(e){this.callbackResponse(e,4001),this.sendData({cmd:4001,description:"tsdk_searchLadp",param:{searchParam:""}})},e.prototype.setBasicEvent=function(e){"function"==typeof e.onEvtLadpSearchResult&&(this.serviceTunnel.notifyFuncs[4002]=e.onEvtLadpSearchResult)},e}(),i=function(){function n(){if(n.wrapper)throw Error("tsdkManagerWrapper has exist");n.wrapper=this}return n.prototype.build=function(t,i,s,c,a,u){var p=this;if(!n.socketService||1!=n.socketService.socket.readyState){var l=new Promise((function(n,t){p.onWebsocketReady=function(t){n(""),e.info("tsdkManagerWrapper","websocket connect sucesss"),c&&"function"==typeof c&&c.call(null,"websocket链接成功")}})),f={svraddr:t,svrport:i,ssl:s,close:function(e){a&&"function"==typeof a&&a.call(null,e)},ready:this.onWebsocketReady,error:function(e){u&&"function"==typeof u&&u.call(null,e)}};return n.socketService=new o(f),n.tsdkManage=new r({socket:n.socketService}),l}e.info("tsdkManagerWrapper","websocket is connecting ")},n.getInstance=function(){return n.wrapper},n.prototype.onCloseWebsocket=function(){e.error("tsdkManagerWrapper","websocketService connect is closed")},n.prototype.searchLadp=function(){var e={response:{}},t=new Promise((function(n,t){e.response=function(e){n(e)}}));return n.tsdkManage.searchLadp(e),t},n.prototype.registerManageEvent=function(e){n.tsdkManage.setBasicEvent(e)},n.wrapper=new n,n}(),s=function(){function n(){if(n.wrapper)throw Error("tsdkLoginWrapper has exist");n.wrapper=this}return n.prototype.build=function(){e.info("tsdkLoginWrapper","tsdkLoginWrapper has build"),n.tsdkLogin=new t({socket:i.socketService})},n.getInstance=function(){return n.wrapper},n.prototype.login=function(e){var t={response:{}},o=new Promise((function(e,n){t.response=function(n){e(n)}}));return n.tsdkLogin.login(e,t),o},n.prototype.registerLoginEvent=function(e){n.tsdkLogin.setBasicEvent(e)},n.wrapper=new n,n}();const c=function(){function t(){this.wrapper=s.getInstance(),this.wrapper.build(),this.registerLoginEvent()}return t.prototype.login=function(e,n){return t=this,o=void 0,i=function(){var t;return function(e,n){var t,o,r,i,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(i){return function(c){return function(i){if(t)throw new TypeError("Generator is already executing.");for(;s;)try{if(t=1,o&&(r=2&i[0]?o.return:i[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,i[1])).done)return r;switch(o=0,r&&(i=[2&i[0],r.value]),i[0]){case 0:case 1:r=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,o=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!((r=(r=s.trys).length>0&&r[r.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){s.label=i[1];break}if(6===i[0]&&s.label<r[1]){s.label=r[1],r=i;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(i);break}r[2]&&s.ops.pop(),s.trys.pop();continue}i=n.call(e,s)}catch(e){i=[6,e],o=0}finally{t=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,c])}}}(this,(function(o){switch(o.label){case 0:return[4,this.wrapper.login(e)];case 1:return t=o.sent(),n(t),[2]}}))},new((r=void 0)||(r=Promise))((function(e,n){function s(e){try{a(i.next(e))}catch(e){n(e)}}function c(e){try{a(i.throw(e))}catch(e){n(e)}}function a(n){var t;n.done?e(n.value):(t=n.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,c)}a((i=i.apply(t,o||[])).next())}));var t,o,r,i},t.prototype.registerLoginEvent=function(){e.info("tsdkLoginService","registerLoginEvent"),this.wrapper.registerLoginEvent({onEvtLoginSuccess:t.handleOnEvtLoginSuccess,onEvtLoginFailed:t.handleonEvtLoginFailed})},t.handleOnEvtLoginSuccess=function(e){n.publish("onEvtLoginSuccess",e)},t.handleonEvtLoginFailed=function(e){n.publish("onEvtLoginFailed",e)},t}();const a=function(){function t(e,t,o,r){var s=this;this.wrapper=i.getInstance();var c=function(){r&&"function"==typeof r&&r(null)},a=function(){n.publish("onEvtWebSocketClose","服务器连接异常"),n.reconnect(),setTimeout((function(){s.wrapper.build(e,t,o,c,a,u)}),3e3)},u=function(){};this.wrapper.build(e,t,o,c,a,u),this.registerManagerEvent()}return t.prototype.searchLadp=function(e){return n=this,t=void 0,r=function(){var n;return function(e,n){var t,o,r,i,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(i){return function(c){return function(i){if(t)throw new TypeError("Generator is already executing.");for(;s;)try{if(t=1,o&&(r=2&i[0]?o.return:i[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,i[1])).done)return r;switch(o=0,r&&(i=[2&i[0],r.value]),i[0]){case 0:case 1:r=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,o=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!((r=(r=s.trys).length>0&&r[r.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){s.label=i[1];break}if(6===i[0]&&s.label<r[1]){s.label=r[1],r=i;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(i);break}r[2]&&s.ops.pop(),s.trys.pop();continue}i=n.call(e,s)}catch(e){i=[6,e],o=0}finally{t=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,c])}}}(this,(function(t){switch(t.label){case 0:return[4,this.wrapper.searchLadp()];case 1:return n=t.sent(),e(n),[2]}}))},new((o=void 0)||(o=Promise))((function(e,i){function s(e){try{a(r.next(e))}catch(e){i(e)}}function c(e){try{a(r.throw(e))}catch(e){i(e)}}function a(n){var t;n.done?e(n.value):(t=n.value,t instanceof o?t:new o((function(e){e(t)}))).then(s,c)}a((r=r.apply(n,t||[])).next())}));var n,t,o,r},t.prototype.registerManagerEvent=function(){e.info("tsdkManagerService","registerManagerEvent"),this.wrapper.registerManageEvent({onEvtLadpSearchResult:t.handleOnEvtLadpSearchResult})},t.handleOnEvtLadpSearchResult=function(e){n.publish("onEvtLadpSearchResult",e)},t}(),u=function(){function e(e){this.serviceTunnel=e.socket}return e.prototype.sendData=function(e){var n=JSON.stringify(e);this.serviceTunnel.socket&&this.serviceTunnel.sendData(n)},e.prototype.callbackResponse=function(e,n){e.response&&"function"==typeof e.response&&(this.serviceTunnel.rspFuncs[n]=e.response)},e.prototype.uploadFile=function(e,n){this.callbackResponse(n,2001),this.sendData({cmd:2001,description:"tsdk_upload_file",param:{file_sub_name:"文件标题",file:"test"}})},e.prototype.setBasicEvent=function(e){"function"==typeof e.onEvtUploadFileSuccess&&(this.serviceTunnel.notifyFuncs[2002]=e.onEvtUploadFileSuccess)},e}(),p=function(){function n(){if(n.wrapper)throw Error("tsdkMainWrapper has exist");n.wrapper=this}return n.prototype.build=function(){e.info("tsdkMainWrapper","tsdkMainWrapper has build"),n.tsdkMain=new u({socket:i.socketService})},n.getInstance=function(){return n.wrapper},n.prototype.uploadFile=function(e){var t={response:{}},o=new Promise((function(e,n){t.response=function(n){e(n)}}));return n.tsdkMain.uploadFile(e,t),o},n.prototype.registerMainEvent=function(e){n.tsdkMain.setBasicEvent(e)},n.wrapper=new n,n}();const l=function(){function t(){this.wrapper=p.getInstance(),this.wrapper.build(),this.registerMainEvent()}return t.prototype.uploadFile=function(e,n){return t=this,o=void 0,i=function(){var t;return function(e,n){var t,o,r,i,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(i){return function(c){return function(i){if(t)throw new TypeError("Generator is already executing.");for(;s;)try{if(t=1,o&&(r=2&i[0]?o.return:i[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,i[1])).done)return r;switch(o=0,r&&(i=[2&i[0],r.value]),i[0]){case 0:case 1:r=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,o=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!((r=(r=s.trys).length>0&&r[r.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){s.label=i[1];break}if(6===i[0]&&s.label<r[1]){s.label=r[1],r=i;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(i);break}r[2]&&s.ops.pop(),s.trys.pop();continue}i=n.call(e,s)}catch(e){i=[6,e],o=0}finally{t=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,c])}}}(this,(function(o){switch(o.label){case 0:return[4,this.wrapper.uploadFile(e)];case 1:return t=o.sent(),n(t),[2]}}))},new((r=void 0)||(r=Promise))((function(e,n){function s(e){try{a(i.next(e))}catch(e){n(e)}}function c(e){try{a(i.throw(e))}catch(e){n(e)}}function a(n){var t;n.done?e(n.value):(t=n.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,c)}a((i=i.apply(t,o||[])).next())}));var t,o,r,i},t.prototype.registerMainEvent=function(){e.info("tsdkMainService","registerMainEvent"),this.wrapper.registerMainEvent({onEvtUploadFileSuccess:t.handleOnEvtUploadFileSuccess})},t.handleOnEvtUploadFileSuccess=function(e){n.publish("onEvtUploadFileSuccess",e)},t}(),f=function(){function e(e){this.serviceTunnel=e.socket}return e.prototype.sendData=function(e){var n=JSON.stringify(e);this.serviceTunnel.socket&&this.serviceTunnel.sendData(n)},e.prototype.callbackResponse=function(e,n){e.response&&"function"==typeof e.response&&(this.serviceTunnel.rspFuncs[n]=e.response)},e.prototype.singlePersonChat=function(e,n){this.callbackResponse(n,3001);var t={cmd:3001,description:"tsdk_single_person_chat",param:{chatInfo:e}};this.sendData(t)},e.prototype.setBasicEvent=function(e){"function"==typeof e.onEvtNewsInComing&&(this.serviceTunnel.notifyFuncs[3002]=e.onEvtNewsInComing)},e}(),v=function(){function n(){if(n.wrapper)throw Error("tsdkChatWrapper has exist");n.wrapper=this}return n.prototype.build=function(){e.info("tsdkChatWrapper","tsdkChatWrapper has build"),n.tsdkChat=new f({socket:i.socketService})},n.getInstance=function(){return n.wrapper},n.prototype.singlePersonChat=function(e){var t={response:{}},o=new Promise((function(e,n){t.response=function(n){e(n)}}));return n.tsdkChat.singlePersonChat(e,t),o},n.prototype.registerChatEvent=function(e){n.tsdkChat.setBasicEvent(e)},n.wrapper=new n,n}();const h=function(){function t(){this.wrapper=v.getInstance(),this.wrapper.build(),this.registerChatEvent()}return t.prototype.singlePersonChat=function(e,n){return t=this,o=void 0,i=function(){var t;return function(e,n){var t,o,r,i,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(i){return function(c){return function(i){if(t)throw new TypeError("Generator is already executing.");for(;s;)try{if(t=1,o&&(r=2&i[0]?o.return:i[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,i[1])).done)return r;switch(o=0,r&&(i=[2&i[0],r.value]),i[0]){case 0:case 1:r=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,o=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!((r=(r=s.trys).length>0&&r[r.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){s.label=i[1];break}if(6===i[0]&&s.label<r[1]){s.label=r[1],r=i;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(i);break}r[2]&&s.ops.pop(),s.trys.pop();continue}i=n.call(e,s)}catch(e){i=[6,e],o=0}finally{t=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,c])}}}(this,(function(o){switch(o.label){case 0:return[4,this.wrapper.singlePersonChat(e)];case 1:return t=o.sent(),n(t),[2]}}))},new((r=void 0)||(r=Promise))((function(e,n){function s(e){try{a(i.next(e))}catch(e){n(e)}}function c(e){try{a(i.throw(e))}catch(e){n(e)}}function a(n){var t;n.done?e(n.value):(t=n.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,c)}a((i=i.apply(t,o||[])).next())}));var t,o,r,i},t.prototype.registerChatEvent=function(){e.info("tsdkChatService","registerChatEvent"),this.wrapper.registerChatEvent({onEvtNewsInComing:t.handleOnEvtNewsInComing})},t.handleOnEvtNewsInComing=function(e){n.publish("onEvtNewsInComing",e)},t}(),d=function(){function e(n){e.managerService=new a(n.svraddr,n.port,n.ssl,this.reconnectSucessCallback),e.loginService=new c,e.mainService=new l,e.tsdkChatService=new h,this.registerWebsocketEvent(),this.registerLoginEvent(),this.registerMainEvent(),this.registerChatEvent(),this.registerManageEvent()}return e.prototype.reconnectSucessCallback=function(){n.getReconnectStatus()&&(e.loginService=new c,e.mainService=new l,e.tsdkChatService=new h,e.managerService.registerManagerEvent(),n.resetReconnect()),n.publish("onEvtWebSocketConnect","服务器连接成功")},e.prototype.login=function(n,t){e.loginService.login(n,t)},e.prototype.singlePersonChat=function(n,t){e.tsdkChatService.singlePersonChat(n,t)},e.prototype.searchLadp=function(n){e.managerService.searchLadp(n)},e.prototype.uploadFile=function(n,t){e.mainService.uploadFile(n,t)},e.prototype.notify=function(n,t){var o=e.__listeners[n];if(!o)return!1;for(var r=0;r<o.length;r++)"function"==typeof o[r]&&o[r](t)},e.prototype.on=function(n,t){e.__listeners[n]||(e.__listeners[n]=[]),e.__listeners[n].push(t)},e.prototype.registerLoginEvent=function(){var e=this;n.subscribe("onEvtLoginSuccess",(function(n){e.notify("onEvtLoginSuccess",n)})),n.subscribe("onEvtLoginFailed",(function(n){e.notify("onEvtLoginFailed",n)}))},e.prototype.registerMainEvent=function(){var e=this;n.subscribe("onEvtUploadFileSuccess",(function(n){e.notify("onEvtUploadFileSuccess",n)}))},e.prototype.registerChatEvent=function(){var e=this;n.subscribe("onEvtNewsInComing",(function(n){e.notify("onEvtNewsInComing",n)}))},e.prototype.registerManageEvent=function(){var e=this;n.subscribe("onEvtLadpSearchResult",(function(n){e.notify("onEvtLadpSearchResult",n)}))},e.prototype.registerWebsocketEvent=function(){var e=this;n.subscribe("onEvtWebSocketConnect",(function(n){e.notify("onEvtWebSocketConnect",n)})),n.subscribe("onEvtWebSocketClose",(function(n){e.notify("onEvtWebSocketClose",n)}))},e.__listeners={},e}(),g=function(){function n(){}return n.tsdkCreateClient=function(t,o){try{n.tsdkClient=new d(t)}catch(n){e.error("terminalSDK","terminal create failed..."+n)}return n.tsdkClient?(o&&"undefined"!=o.onEvtLoginSuccess&&n.tsdkClient.on("onEvtLoginSuccess",o.onEvtLoginSuccess),o&&"undefined"!=o.onEvtLoginFailed&&n.tsdkClient.on("onEvtLoginFailed",o.onEvtLoginFailed),o&&"undefined"!=o.onEvtUploadFileSuccess&&n.tsdkClient.on("onEvtUploadFileSuccess",o.onEvtUploadFileSuccess),o&&"undefined"!=o.onEvtNewsInComing&&n.tsdkClient.on("onEvtNewsInComing",o.onEvtNewsInComing),o&&"undefined"!=o.onEvtLadpSearchResult&&n.tsdkClient.on("onEvtLadpSearchResult",o.onEvtLadpSearchResult),o&&"undefined"!=o.onEvtWebSocketConnect&&n.tsdkClient.on("onEvtWebSocketConnect",o.onEvtWebSocketConnect),o&&"undefined"!=o.onEvtWebSocketClose&&n.tsdkClient.on("onEvtWebSocketClose",o.onEvtWebSocketClose),n.tsdkClient):""},n}();module.exports={terminalSDK:g}})();